<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Picture Reveal Game (Synced)</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', sans-serif;
      background: #1a1a1a;
      color: white;
      overflow: hidden;
      height: 100vh;
    }
    .main-layout {
      display: flex;
      flex-direction: row;
      justify-content: center;
      align-items: flex-start;
      padding: 1rem;
      height: 100vh;
      box-sizing: border-box;
      gap: 1.5rem;
    }
    .grid {
      position: relative;
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      grid-template-rows: repeat(4, 1fr);
      gap: 0;
      width: 70vw;
      max-width: 700px;
      aspect-ratio: 5 / 4;
      border-radius: 10px;
      overflow: hidden;
      user-select: none;
    }
    .grid img {
      position: absolute;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      z-index: 0;
      pointer-events: none;
    }
    .square {
      background: #2a2a2a;
      border: 1px solid #1a1a1a;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 4rem;
      font-weight: bold;
      color: white;
      cursor: pointer;
      transition: opacity 2s ease;
      z-index: 2;
      position: relative;
    }
    .square.revealed {
      opacity: 0;
      pointer-events: none;
    }
    .square.even { background-color: #3e8e41; }
    .square:not(.even) { background-color: #6fcf97; }

    .controls {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      align-items: center;
      margin-top: 1rem;
      z-index: 10;
    }
    .control-btn {
      width: 180px;
      height: 52px;
      font-size: 1.2rem;
      font-weight: bold;
      border-radius: 12px;
      background: #333;
      color: gold;
      border: 2px solid gold;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      cursor: pointer;
    }
    #previewImage {
      width: 180px;
      height: auto;
      margin-top: 1rem;
      border: 2px solid gold;
      border-radius: 8px;
      display: none;
    }

    #star {
      position: fixed;
      font-size: 10rem;
      color: gold;
      text-shadow: -2px -2px 5px #000, 2px -2px 5px #000, -2px 2px 5px #000, 2px 2px 5px #000;
      pointer-events: none;
      user-select: none;
      z-index: 9999;
      transform: translate(-50%, -50%);
      transition: all 1s ease, opacity 1s ease;
    }

    body.display-mode .controls,
    body.display-mode #previewImage {
      display: none !important;
    }

    #uploadOverlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.85);
      color: gold;
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      font-size: 1.5rem;
      font-weight: bold;
      text-align: center;
    }
  </style>
</head>
<body>
<div class="main-layout">
  <div class="grid" id="grid">
    <img id="hiddenImage" src="" alt="Hidden picture" />
  </div>
  <div class="controls">
    <button id="load-images" class="control-btn">üìÅ Load Images</button>
    <button id="new-game" class="control-btn">üîÑ New Game</button>
    <button id="reveal-all" class="control-btn">üëÅÔ∏è Reveal All</button>
    <button id="kiosk-mode" class="control-btn">üñ•Ô∏è Kiosk Mode</button>
    <button id="toggle-display" class="control-btn">üì∫ Toggle Display Mode</button>
    <img id="previewImage" alt="Current image preview" />
  </div>
</div>
<div id="uploadOverlay">
  <p>Drag & drop images here or click to select files.<br>Supported: JPG, PNG, GIF.</p>
  <p><em>Press ESC to cancel</em></p>
</div>
<script>
  const TOTAL_SQUARES = 20;
  const grid = document.getElementById("grid");
  const hiddenImage = document.getElementById("hiddenImage");
  const newGameBtn = document.getElementById("new-game");
  const revealAllBtn = document.getElementById("reveal-all");
  const kioskModeBtn = document.getElementById("kiosk-mode");
  const loadImagesBtn = document.getElementById("load-images");
  const toggleDisplayBtn = document.getElementById("toggle-display");
  const previewImage = document.getElementById("previewImage");
  const uploadOverlay = document.getElementById("uploadOverlay");
  const isDisplay = new URLSearchParams(window.location.search).has('display');
  if (isDisplay) document.body.classList.add('display-mode');
  const channel = new BroadcastChannel('picture-reveal');

  let starIndex;
  let uploadedImages = [];
  let usedImages = [];

  channel.onmessage = (e) => {
    const data = e.data;
    if (data.type === 'newGame') {
      setupGrid(data.image, data.starIndex);
    } else if (data.type === 'revealSquare') {
      revealSquare(document.querySelector(`.square[data-index='${data.index}']`));
    } else if (data.type === 'revealAll') {
      revealAll(true);
    } else if (data.type === 'showStar') {
      showStar(document.querySelector(`.square[data-index='${data.index}']`));
    }
  };

  function handleFiles(files) {
    uploadedImages = Array.from(files).filter(f => f.type.startsWith('image/')).map(f => URL.createObjectURL(f));
    usedImages = [];
    if (!uploadedImages.length) return alert('No valid image files.');
    uploadOverlay.style.display = 'none';
    startNewGame();
  }

  function getNextImage() {
    if (!uploadedImages.length) return '';
    let available = uploadedImages.filter(img => !usedImages.includes(img));
    if (!available.length) { usedImages = []; available = uploadedImages; }
    const img = available[Math.floor(Math.random() * available.length)];
    usedImages.push(img);
    return img;
  }

  function setupGrid(image, star) {
    grid.querySelectorAll('.square').forEach(el => el.remove());
    hiddenImage.src = image;
    if (!isDisplay) { previewImage.src = image; previewImage.style.display = 'block'; }
    starIndex = star;
    for (let i = 0; i < TOTAL_SQUARES; i++) {
      const square = document.createElement('div');
      square.className = 'square';
      if (i % 2 === 0) square.classList.add('even');
      square.dataset.index = i;
      if (!isDisplay) square.addEventListener('click', () => {
        revealSquare(square);
        channel.postMessage({ type: 'revealSquare', index: i });
        if (i === starIndex) channel.postMessage({ type: 'showStar', index: i });
      });
      grid.appendChild(square);
    }
  }

  function revealSquare(square) {
    if (!square || square.classList.contains('revealed')) return;
    square.classList.add('revealed');
    if (parseInt(square.dataset.index) === starIndex && isDisplay) showStar(square);
  }

  function revealAll(remote = false) {
    document.querySelectorAll('.square').forEach(sq => sq.classList.add('revealed'));
    if (!remote) channel.postMessage({ type: 'revealAll' });
  }

  function showStar(square) {
    const existing = document.getElementById('star');
    if (existing) existing.remove();
    const star = document.createElement('div');
    star.id = 'star';
    star.textContent = '‚òÖ';
    document.body.appendChild(star);
    const rect = square.getBoundingClientRect();
    star.style.left = `${rect.left + rect.width/2}px`;
    star.style.top = `${rect.top + rect.height/2}px`;
    star.style.transform = 'translate(-50%, -50%) scale(1) rotate(0deg)';
    setTimeout(() => {
      star.style.transition = 'all 1s ease';
      star.style.left = `${window.innerWidth/2}px`;
      star.style.top = `${window.innerHeight/2}px`;
      star.style.transform = 'translate(-50%, -50%) scale(2) rotate(720deg)';
    }, 50);
  }

  function startNewGame() {
    const image = getNextImage();
    if (!image) return alert('Upload images first!');
    const star = Math.floor(Math.random() * TOTAL_SQUARES);
    setupGrid(image, star);
    if (!isDisplay) channel.postMessage({ type: 'newGame', image, starIndex: star });
  }

  const fileInput = document.createElement('input');
  fileInput.type = 'file';
  fileInput.accept = 'image/*';
  fileInput.multiple = true;
  fileInput.style.display = 'none';
  document.body.appendChild(fileInput);
  fileInput.addEventListener('change', () => handleFiles(fileInput.files));
  loadImagesBtn.onclick = () => uploadOverlay.style.display = 'flex';
  uploadOverlay.addEventListener('click', () => fileInput.click());
  document.addEventListener('keydown', e => { if (e.key === 'Escape') uploadOverlay.style.display = 'none'; });

  newGameBtn.onclick = () => startNewGame();
  revealAllBtn.onclick = () => revealAll();
  kioskModeBtn.onclick = () => { if (!document.fullscreenElement) document.documentElement.requestFullscreen(); else document.exitFullscreen(); };
  toggleDisplayBtn.onclick = () => document.body.classList.toggle('display-mode');

  if (isDisplay) channel.postMessage({ type: 'syncRequest' });
</script>
</body>
</html>
