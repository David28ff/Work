<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Picture Reveal Game</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', sans-serif;
      background: #1a1a1a;
      color: white;
      overflow: hidden;
      height: 100vh;
    }
    .main-layout {
      display: flex;
      flex-direction: row;
      justify-content: center;
      align-items: flex-start;
      padding: 1rem;
      height: 100vh;
      box-sizing: border-box;
      gap: 1.5rem;
    }
    .grid {
      position: relative;
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      grid-template-rows: repeat(4, 1fr);
      gap: 0;
      width: 70vw;
      max-width: 700px;
      aspect-ratio: 5 / 4;
      border-radius: 10px;
      overflow: hidden;
      user-select: none;
    }
    .grid img {
      position: absolute;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      z-index: 0;
      pointer-events: none;
    }
    .square {
      background: #2a2a2a;
      border: 1px solid #1a1a1a;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 4rem;
      font-weight: bold;
      color: white;
      cursor: pointer;
      transition: opacity 2s ease;
      z-index: 2;
      position: relative;
    }
    .square.revealed {
      opacity: 0;
      pointer-events: none;
    }
    .square.even { background-color: #3e8e41; }
    .square:not(.even) { background-color: #6fcf97; }

    .number {
      display: inline-block;
      transition: transform 0.2s ease;
      user-select: none;
    }
    .number.grow {
      transform: scale(1.25);
    }

    .controls {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      align-items: center;
      margin-top: 1rem;
      z-index: 10;
    }
    .control-btn {
      width: 180px;
      height: 52px;
      font-size: 1.2rem;
      font-weight: bold;
      border-radius: 12px;
      background: #333;
      color: gold;
      border: 2px solid gold;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      cursor: pointer;
      transition: transform 0.3s ease;
    }
    #previewImage {
      width: 180px;
      height: auto;
      margin-top: 1rem;
      border: 2px solid gold;
      border-radius: 8px;
      display: none;
    }

    #star {
      position: fixed;
      font-size: 10rem;
      color: gold;
      text-shadow:
        -2px -2px 5px #000,
        2px -2px 5px #000,
        -2px 2px 5px #000,
        2px 2px 5px #000;
      pointer-events: none;
      user-select: none;
      z-index: 9999;
      transform: translate(-50%, -50%);
      transition: all 1s ease, opacity 1s ease;
      filter: drop-shadow(0 0 8px gold);
    }

    #uploadOverlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.85);
      color: gold;
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      font-size: 1.5rem;
      font-weight: bold;
      padding: 2rem;
      text-align: center;
    }
    #uploadOverlay.hover {
      background: rgba(100, 150, 50, 0.9);
    }

    /* Display mode: hide controls when activated */
    .display-mode .control-panel {
      display: none !important;
    }
    .display-mode .main-layout {
      justify-content: center;
      align-items: center;
    }
    .display-mode .grid {
      width: 90vw;
      max-width: 1000px;
    }
  </style>
</head>
<body>

<div class="main-layout">
  <div class="grid" id="grid" role="grid" aria-label="Game grid">
    <img id="hiddenImage" src="" alt="Hidden picture" />
  </div>
  <div class="controls control-panel" role="region" aria-label="Game controls">
    <button id="load-images" class="control-btn"><span class="icon">üìÅ</span> Load Images</button>
    <button id="new-game" class="control-btn"><span class="icon">üîÑ</span> New Game</button>
    <button id="reveal-all" class="control-btn"><span class="icon">üëÅÔ∏è</span> Reveal All</button>
    <button id="kiosk-mode" class="control-btn"><span class="icon">üñ•Ô∏è</span> Kiosk Mode</button>
    <button id="toggle-display" class="control-btn"><span class="icon">üì∫</span> Toggle Display Mode</button>
    <img id="previewImage" alt="Current image preview" />
  </div>
</div>

<div id="uploadOverlay" role="alert" aria-live="assertive">
  <p>Drag & drop images here or click to select files.<br>Supported: JPG, PNG, GIF.</p>
  <p><em>Press ESC to cancel</em></p>
</div>

<script>
  const TOTAL_SQUARES = 20;
  const grid = document.getElementById("grid");
  const hiddenImage = document.getElementById("hiddenImage");
  const newGameBtn = document.getElementById("new-game");
  const revealAllBtn = document.getElementById("reveal-all");
  const kioskModeBtn = document.getElementById("kiosk-mode");
  const loadImagesBtn = document.getElementById("load-images");
  const toggleDisplayBtn = document.getElementById("toggle-display");
  const uploadOverlay = document.getElementById("uploadOverlay");
  const controls = document.querySelector('.controls');
  const previewImage = document.getElementById('previewImage');
  let starIndex, uploadedImages = [], usedImages = [], animatingStar = false;

  function handleFiles(files) {
    const validFiles = Array.from(files).filter(f => f.type.startsWith("image/"));
    if (!validFiles.length) return alert("No valid image files.");
    const readers = validFiles.map(file => new Promise(resolve => {
      const reader = new FileReader();
      reader.onload = e => resolve(e.target.result);
      reader.readAsDataURL(file);
    }));
    Promise.all(readers).then(results => {
      uploadedImages = results;
      usedImages = [];
      uploadOverlay.style.display = "none";
      startNewGame();
    });
  }

  function getNextImage() {
    if (!uploadedImages.length) return "";
    let available = uploadedImages.filter(img => !usedImages.includes(img));
    if (!available.length) { usedImages = []; available = uploadedImages; }
    const img = available[Math.floor(Math.random() * available.length)];
    usedImages.push(img);
    return img;
  }

  function createGrid() {
    grid.querySelectorAll(".square").forEach(el => el.remove());
    const image = getNextImage();
    if (!image) return alert("Upload images first!");
    hiddenImage.src = image;
    previewImage.src = image;
    previewImage.style.display = 'block';
    starIndex = Math.floor(Math.random() * TOTAL_SQUARES);
    for (let i = 0; i < TOTAL_SQUARES; i++) {
      const square = document.createElement("div");
      square.className = "square";
      if (i % 2 === 0) square.classList.add("even");
      square.dataset.index = i;
      square.addEventListener("click", () => revealSquare(square));
      grid.appendChild(square);
    }
    revealNumbersSequentially();
  }

  function revealNumbersSequentially() {
    const squares = Array.from(document.querySelectorAll(".square"));
    const sequence = [...Array(squares.length).keys()];
    const delays = sequence.map(() => Math.random());
    sequence
      .map((i, idx) => ({ i, delay: delays[idx] }))
      .sort((a, b) => a.delay - b.delay)
      .forEach((item, idx) => {
        setTimeout(() => {
          const square = squares[item.i];
          const oldNum = square.querySelector('.number');
          if (oldNum) oldNum.remove();
          const number = document.createElement("span");
          number.classList.add("number", "grow");
          number.textContent = item.i + 1;
          square.appendChild(number);
          setTimeout(() => number.classList.remove("grow"), 200);
        }, (idx / TOTAL_SQUARES) * 4000);
      });
  }

  function revealSquare(square) {
    if (square.classList.contains("revealed")) return;
    square.classList.add("revealed");
    if (parseInt(square.dataset.index) === starIndex) showStar(square);
  }

  function revealAll() {
    const starSquare = document.querySelector(`.square[data-index='${starIndex}']`);
    const starRevealed = starSquare?.classList.contains("revealed");
    if (!starRevealed) {
      document.querySelectorAll(".square").forEach(sq => sq.classList.add("revealed"));
    } else {
      document.querySelectorAll(".square").forEach(sq => revealSquare(sq));
    }
  }

  function showStar(square) {
    if (animatingStar) return;
    animatingStar = true;
    const existing = document.getElementById("star");
    if (existing) existing.remove();
    const star = document.createElement("div");
    star.id = "star";
    star.textContent = "‚òÖ";
    document.body.appendChild(star);
    const rect = square.getBoundingClientRect();
    star.style.left = `${rect.left + rect.width / 2}px`;
    star.style.top = `${rect.top + rect.height / 2}px`;
    star.style.transform = "translate(-50%, -50%) scale(1) rotate(0deg)";
    star.style.opacity = "1";
    setTimeout(() => {
      star.style.transition = "all 1s ease";
      star.style.left = `${window.innerWidth / 2}px`;
      star.style.top = `${window.innerHeight / 2}px`;
      star.style.transform = "translate(-50%, -50%) scale(2) rotate(720deg)";
    }, 50);
    setTimeout(() => animatingStar = false, 4000);
  }

  function fadeOutStar(callback) {
    const star = document.getElementById("star");
    if (!star) return callback();
    star.style.transition = "opacity 1s ease";
    star.style.opacity = "0";
    setTimeout(() => { star.remove(); callback(); }, 1000);
  }

  function startNewGame() {
    fadeOutStar(() => createGrid());
  }

  document.createElement("input");
  const fileInput = document.createElement("input");
  fileInput.type = "file";
  fileInput.accept = "image/*";
  fileInput.multiple = true;
  fileInput.style.display = "none";
  document.body.appendChild(fileInput);

  fileInput.addEventListener("change", () => handleFiles(fileInput.files));
  loadImagesBtn.addEventListener("click", () => uploadOverlay.style.display = "flex");
  uploadOverlay.addEventListener("dragover", e => { e.preventDefault(); uploadOverlay.classList.add("hover"); });
  uploadOverlay.addEventListener("dragleave", e => { e.preventDefault(); uploadOverlay.classList.remove("hover"); });
  uploadOverlay.addEventListener("drop", e => { e.preventDefault(); uploadOverlay.classList.remove("hover"); handleFiles(e.dataTransfer.files); });
  uploadOverlay.addEventListener("click", () => fileInput.click());
  document.addEventListener("keydown", e => { if (e.key === "Escape") uploadOverlay.style.display = "none"; });

  newGameBtn.onclick = () => startNewGame();
  revealAllBtn.onclick = () => revealAll();
  kioskModeBtn.onclick = () => document.fullscreenElement ? document.exitFullscreen() : document.documentElement.requestFullscreen();
  toggleDisplayBtn.onclick = () => document.body.classList.toggle("display-mode");

  createGrid();
</script>
</body>
</html>
